{% extends 'base.html' %}
{% load static %}
{% load user_tags %}


{% block title %}Budget - {{ club.name }} - AESI Platform{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Modern Header -->
    {% include 'clubs/_club_header.html' with club=club show_contact=False show_stats=True %}

    <!-- Modern Navigation -->
    {% include 'clubs/_club_nav.html' with club=club active_tab='budget' %}

    <!-- Financial Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
        <!-- Total Income -->
        <div class="group bg-gradient-to-br from-white to-green-50 rounded-lg sm:rounded-xl shadow-lg sm:shadow-xl p-4 sm:p-6 md:p-8 border-2 border-green-200 hover:shadow-2xl transition-all duration-300">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <dt class="text-xs sm:text-sm font-bold text-green-600 uppercase tracking-wide mb-1 sm:mb-2">Total EntrÉes</dt>
                    <dd class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-gray-900 mb-1">{{ total_income|floatformat:0 }}</dd>
                    <div class="text-xs sm:text-sm font-semibold text-green-700">FCFA</div>
                </div>
                <div class="flex-shrink-0 p-3 sm:p-4 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl sm:rounded-2xl shadow-lg group-hover:scale-110 transition">
                    <svg class="h-8 w-8 sm:h-10 sm:w-10 md:h-12 md:w-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Total Expenses -->
        <div class="group bg-gradient-to-br from-white to-red-50 rounded-lg sm:rounded-xl shadow-lg sm:shadow-xl p-4 sm:p-6 md:p-8 border-2 border-red-200 hover:shadow-2xl transition-all duration-300">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <dt class="text-xs sm:text-sm font-bold text-red-600 uppercase tracking-wide mb-1 sm:mb-2">Total Sorties</dt>
                    <dd class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-gray-900 mb-1">{{ total_expenses|floatformat:0 }}</dd>
                    <div class="text-xs sm:text-sm font-semibold text-red-700">FCFA</div>
                </div>
                <div class="flex-shrink-0 p-3 sm:p-4 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl sm:rounded-2xl shadow-lg group-hover:scale-110 transition">
                    <svg class="h-8 w-8 sm:h-10 sm:w-10 md:h-12 md:w-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Balance -->
        <div class="group bg-gradient-to-br from-white {% if balance >= 0 %}to-blue-50 border-blue-200{% else %}to-orange-50 border-orange-200{% endif %} rounded-lg sm:rounded-xl shadow-lg sm:shadow-xl p-4 sm:p-6 md:p-8 border-2 hover:shadow-2xl transition-all duration-300">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <dt class="text-xs sm:text-sm font-bold {% if balance >= 0 %}text-primary{% else %}text-orange-600{% endif %} uppercase tracking-wide mb-1 sm:mb-2">Solde</dt>
                    <dd class="text-2xl sm:text-3xl md:text-4xl font-extrabold {% if balance >= 0 %}text-green-600{% else %}text-red-600{% endif %} mb-1">{{ balance|floatformat:0 }}</dd>
                    <div class="text-xs sm:text-sm font-semibold {% if balance >= 0 %}text-blue-700{% else %}text-orange-700{% endif %}">FCFA</div>
                </div>
                <div class="flex-shrink-0 p-3 sm:p-4 bg-gradient-to-br {% if balance >= 0 %}from-primary to-primary-dark{% else %}from-orange-500 to-red-600{% endif %} rounded-xl sm:rounded-2xl shadow-lg group-hover:scale-110 transition">
                    <svg class="h-8 w-8 sm:h-10 sm:w-10 md:h-12 md:w-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Chart -->
    <div class="bg-gradient-to-br from-white to-rose-50 rounded-2xl shadow-xl p-8 border border-rose-100">
        <div class="flex items-center gap-3 mb-6">
            <div class="p-3 bg-gradient-to-r from-rose-600 to-pink-600 rounded-xl">
                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-rose-600 bg-clip-text text-transparent">Ã‰volution des DÉpenses par ActivitÉ</h2>
        </div>
        <div id="expense-chart" style="width:100%;height:500px;"></div>
    </div>

    <!-- Add Expense Form -->
    {% if user|can_modify_finances:club %}
    <div class="bg-white rounded-lg shadow-md p-6" x-data="{ showForm: false }">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-neutral-dark">Ajouter une DÉpense</h2>
            <button @click="showForm = !showForm" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-md transition">
                <span x-show="!showForm">+ Nouvelle DÉpense</span>
                <span x-show="showForm">Annuler</span>
            </button>
        </div>
        
        <div x-show="showForm" x-transition class="border-t pt-6">
            <form method="POST" action="{% url 'clubs:add_expense' slug=club.slug %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="activity" class="block text-sm font-medium text-gray-700 mb-2">ActivitÉ *</label>
                        <select id="activity" name="activity" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">SÉlectionner une activitÉ</option>
                            {% for activity in activities %}
                            <option value="{{ activity.id }}">{{ activity.title }} - {{ activity.date|date:"d/m/Y" }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="transaction_date" class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                        <input type="date" id="transaction_date" name="transaction_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>

                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Montant (FCFA) *</label>
                        <input type="number" id="amount" name="amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0">
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">CatÉgorie *</label>
                        <input type="text" id="category" name="category" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Transport, Logistique, etc.">
                    </div>

                    <div class="md:col-span-2">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Motif *</label>
                        <input type="text" id="description" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Description de la dÉpense">
                    </div>

                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Commentaires</label>
                        <textarea id="notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Informations supplÉmentaires..."></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-md transition">
                        Enregistrer la DÉpense
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <!-- No access message for students -->
    {% endif %}
    
    <!-- Add Income Form -->
    {% if user|can_modify_finances:club %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-8" x-data="{ showIncomeForm: false }">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-neutral-dark flex items-center gap-2">
                <svg class="h-6 w-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Ajouter une EntrÉe de Caisse
            </h2>
            <button @click="showIncomeForm = !showIncomeForm" class="bg-success hover:bg-green-600 text-white px-4 py-2 rounded-md transition">
                <span x-text="showIncomeForm ? 'Masquer' : 'Afficher'"></span>
            </button>
        </div>
        
        <div x-show="showIncomeForm" x-transition class="border-t pt-6">
            <form method="POST" action="{% url 'clubs:add_income' slug=club.slug %}" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Montant (FCFA) *</label>
                        <input type="number" name="amount" step="0.01" min="0.01" required class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-success focus:ring focus:ring-success focus:ring-opacity-20">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                        <input type="date" name="transaction_date" required class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-success focus:ring focus:ring-success focus:ring-opacity-20">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description *</label>
                        <input type="text" name="description" required placeholder="Ex: Cotisation mensuelle" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-success focus:ring focus:ring-success focus:ring-opacity-20">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">CatÉgorie *</label>
                        <input type="text" name="category" required placeholder="Ex: Cotisation, Don, Subvention" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-success focus:ring focus:ring-success focus:ring-opacity-20">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ReÃ§u (optionnel)</label>
                        <input type="file" name="receipt" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-success">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (optionnel)</label>
                        <textarea name="notes" rows="3" placeholder="Notes additionnelles" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-success focus:ring focus:ring-success focus:ring-opacity-20"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" @click="showIncomeForm = false" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Annuler
                    </button>
                    <button type="submit" class="bg-success hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition shadow-lg hover:shadow-xl">
                        ðŸ’° Ajouter l'EntrÉe
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    {% if user.is_aesi_treasurer %}
    <!-- Message for AESI Treasurer (Read-Only) -->
    <div class="bg-blue-50 border-l-4 border-primary p-6 rounded-lg">
        <div class="flex items-center">
            <svg class="h-6 w-6 text-primary mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <h3 class="text-lg font-semibold text-primary-dark">AccÃ¨s en lecture seule</h3>
                <p class="text-sm text-blue-700 mt-1">En tant que TrÉsorier de l'AESI, vous pouvez consulter le budget de tous les clubs mais ne pouvez pas le modifier.</p>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- Filters and Export -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <form method="get" class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
                <label for="year" class="block text-sm font-medium text-gray-700 mb-2">Filtrer par annÉe</label>
                <select name="year" id="year" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">Toutes les annÉes</option>
                    {% for year in available_years %}
                    <option value="{{ year.year }}" {% if year_filter == year.year|stringformat:"s" %}selected{% endif %}>{{ year.year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                    Filtrer
                </button>
                <a href="?export=csv{% if year_filter %}&year={{ year_filter }}{% endif %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition inline-flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Exporter CSV
                </a>
            </div>
        </form>
    </div>
    
    <!-- Expenses Table with Filter -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-neutral-dark">Liste des DÉpenses</h2>
            <div class="flex items-center space-x-2">
                <label for="expense-activity-filter" class="text-sm text-gray-700">Filtrer par activitÉ:</label>
                <select id="expense-activity-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm" onchange="filterExpenses(this.value)">
                    <option value="">Toutes les activitÉs</option>
                    {% for activity in activities %}
                    <option value="{{ activity.id }}">{{ activity.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {% if expenses %}
        <!-- Mobile: Affichage en cartes, Desktop: Tableau -->
        <div class="block md:hidden space-y-3">
            {% for transaction in expenses %}
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">{{ transaction.description }}</p>
                        <p class="text-sm text-gray-600">{{ transaction.activity.title|default:"-" }}</p>
                    </div>
                    <span class="text-lg font-bold text-red-600">{{ transaction.amount|floatformat:0 }} FCFA</span>
                </div>
                <div class="flex flex-wrap gap-2 text-xs">
                    <span class="px-2 py-1 bg-blue-100 text-primary-dark rounded-full">{{ transaction.category }}</span>
                    <span class="text-gray-600">{{ transaction.transaction_date|date:"d/m/Y" }}</span>
                </div>
                {% if transaction.notes %}
                <p class="text-xs text-gray-500 mt-2">{{ transaction.notes }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Desktop: Tableau -->
        <div class="hidden md:block overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ActivitÉ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CatÉgorie</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motif</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commentaires</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="expenses-table-body">
                    {% for expense in expenses %}
                    <tr class="hover:bg-gray-50 expense-row" data-activity-id="{% if expense.activity %}{{ expense.activity.id }}{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ expense.transaction_date|date:"d/m/Y" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if expense.activity %}
                                {{ expense.activity.title }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-primary-dark">
                                {{ expense.category }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            {{ expense.description }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">
                            {{ expense.amount|floatformat:0 }} FCFA
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {{ expense.notes|truncatewords:10 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-right text-sm font-bold text-gray-900">Total:</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600" id="total-expenses">
                            {{ total_expenses|floatformat:0 }} FCFA
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Pagination for Expenses -->
        {% if expenses.has_other_pages %}
        <div class="mt-6 flex justify-center">
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                {% if expenses.has_previous %}
                    <a href="?expenses_page=1{% if year_filter %}&year={{ year_filter }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">First</span>
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </a>
                    <a href="?expenses_page={{ expenses.previous_page_number }}{% if year_filter %}&year={{ year_filter }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        PrÉcÉdent
                    </a>
                {% endif %}
                
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                    Page {{ expenses.number }} sur {{ expenses.paginator.num_pages }}
                </span>
                
                {% if expenses.has_next %}
                    <a href="?expenses_page={{ expenses.next_page_number }}{% if year_filter %}&year={{ year_filter }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Suivant
                    </a>
                    <a href="?expenses_page={{ expenses.paginator.num_pages }}{% if year_filter %}&year={{ year_filter }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Last</span>
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}

        <!-- Statistics by Activity -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for stat in expense_by_activity %}
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-sm text-neutral-dark mb-2">{{ stat.activity__title }}</h4>
                <p class="text-2xl font-bold text-red-600">{{ stat.total|floatformat:0 }} FCFA</p>
                <p class="text-xs text-gray-500 mt-1">{{ stat.count }} dÉpense{{ stat.count|pluralize }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-gray-500 py-8">Aucune dÉpense enregistrÉe pour le moment.</p>
        {% endif %}
    </div>
</div>

<script>
// Plotly Expense Chart
const expenseData = {{ expense_chart_data|safe }};

// Enhance the chart with modern styling
const enhancedExpenseData = expenseData.map(trace => ({
    ...trace,
    marker: {
        color: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#06B6D4', '#F97316'],
        line: { color: '#fff', width: 2 }
    },
    text: trace.y.map(val => val.toLocaleString() + ' FCFA'),
    textposition: 'outside',
    textfont: { size: 11, color: '#374151', weight: 'bold' }
}));

const layout = {
    title: '',
    xaxis: { 
        title: 'ActivitÉ',
        tickangle: -45,
        tickfont: { size: 11 },
        showgrid: false
    },
    yaxis: { 
        title: 'Montant (FCFA)',
        showgrid: true,
        gridcolor: '#F3F4F6',
        zeroline: false
    },
    plot_bgcolor: '#FEFCFB',
    paper_bgcolor: '#ffffff',
    font: { family: 'Inter, system-ui, sans-serif', color: '#374151' },
    margin: { l: 80, r: 40, t: 40, b: 150 },
    bargap: 0.3,
    height: 500
};
const config = { responsive: true, displayModeBar: false };
Plotly.newPlot('expense-chart', enhancedExpenseData, layout, config);

// Filter expenses by activity
function filterExpenses(activityId) {
    const rows = document.querySelectorAll('.expense-row');
    let total = 0;
    
    rows.forEach(row => {
        const rowActivityId = row.dataset.activityId;
        if (activityId === '' || rowActivityId === activityId) {
            row.style.display = '';
            const amountText = row.querySelector('td:nth-child(5)').textContent;
            const amount = parseFloat(amountText.replace(/[^0-9.-]+/g, ''));
            total += amount;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('total-expenses').textContent = total.toFixed(0) + ' FCFA';
}
</script>
{% endblock %}


